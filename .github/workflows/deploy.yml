name: Deploy Mail Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::481534399198:role/tilldash-POC-github-actions-role
          aws-region: eu-west-1

      - name: Retrieve secrets from AWS Secrets Manager
        id: secrets
        run: |
          SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id tilldash/POC/mail-secrets --query SecretString --output text)
          # Mask sensitive values
          echo "::add-mask::$(echo $SECRET_JSON | jq -r .MAIL_ACCOUNTS)"
          echo "::add-mask::$(echo $SECRET_JSON | jq -r .DB_PASSWORD)"
          # Export values for .env creation
          echo "EC2_PUBLIC_IP=$(echo $SECRET_JSON | jq -r .SERVER_PUBLIC_IP)" >> $GITHUB_OUTPUT
          echo "secret_json<<EOF" >> $GITHUB_OUTPUT
          echo "$SECRET_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Retrieve deployment secrets
        id: deploy-secrets
        run: |
          DEPLOY_JSON=$(aws secretsmanager get-secret-value --secret-id tilldash/POC/retailer-secrets --query SecretString --output text)
          echo "::add-mask::$(echo $DEPLOY_JSON | jq -r .EC2_SSH_PRIVATE_KEY)"
          echo "EC2_SSH_KEY<<EOF" >> $GITHUB_OUTPUT
          echo "$(echo $DEPLOY_JSON | jq -r .EC2_SSH_PRIVATE_KEY)" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ steps.deploy-secrets.outputs.EC2_SSH_KEY }}" > ~/.ssh/mail_server_key
          chmod 600 ~/.ssh/mail_server_key
          ssh-keyscan -H ${{ steps.secrets.outputs.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Create .env file from secrets
        env:
          MAIL_SECRETS: ${{ steps.secrets.outputs.secret_json }}
        run: |
          echo "$MAIL_SECRETS" | jq -r 'to_entries | map("\(.key)=\(.value)") | .[]' > .env

      - name: Deploy to EC2
        env:
          EC2_IP: ${{ steps.secrets.outputs.EC2_PUBLIC_IP }}
        run: |
          # Create deployment directory on server
          ssh -i ~/.ssh/mail_server_key -o StrictHostKeyChecking=no ubuntu@${EC2_IP} << 'ENDSSH'
            mkdir -p ~/mail-server
            cd ~/mail-server
            
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              sudo chmod a+r /etc/apt/keyrings/docker.gpg
              echo \
                "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              sudo usermod -aG docker ubuntu
            fi
          ENDSSH

          # Copy files to server
          scp -i ~/.ssh/mail_server_key -o StrictHostKeyChecking=no \
            docker-compose.yml \
            .env \
            setup.sh \
            manage-accounts.sh \
            test-email.sh \
            ubuntu@${EC2_IP}:~/mail-server/

          # Make scripts executable and run setup
          ssh -i ~/.ssh/mail_server_key -o StrictHostKeyChecking=no ubuntu@${EC2_IP} << 'ENDSSH'
            cd ~/mail-server
            chmod +x *.sh
            
            # Run setup script
            ./setup.sh
            
            echo "✓ Mail server deployed successfully!"
            
            # Display service status
            docker compose ps
          ENDSSH

      - name: Configure DNS (if AWS credentials provided)
        if: ${{ steps.secrets.outputs.EC2_PUBLIC_IP != '' }}
        run: |
          # AWS credentials already configured from previous step
          # Install AWS CLI
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          
          # Configure DNS
          DOMAIN="${{ secrets.MAIL_DOMAIN }}"
          HOSTNAME="${{ secrets.MAIL_HOSTNAME }}"
          IP="${{ secrets.SERVER_PUBLIC_IP }}"
          ZONE_ID="${{ secrets.AWS_HOSTED_ZONE_ID }}"
          
          # Create DNS records
          cat > dns-changes.json <<EOF
          {
            "Changes": [
              {
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "${HOSTNAME}",
                  "Type": "A",
                  "TTL": 3600,
                  "ResourceRecords": [{"Value": "${IP}"}]
                }
              },
              {
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "${DOMAIN}",
                  "Type": "MX",
                  "TTL": 3600,
                  "ResourceRecords": [{"Value": "10 ${HOSTNAME}"}]
                }
              },
              {
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "${DOMAIN}",
                  "Type": "TXT",
                  "TTL": 3600,
                  "ResourceRecords": [{"Value": "\"v=spf1 mx ip4:${IP} ~all\""}]
                }
              },
              {
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "_dmarc.${DOMAIN}",
                  "Type": "TXT",
                  "TTL": 3600,
                  "ResourceRecords": [{"Value": "\"v=DMARC1; p=quarantine; rua=mailto:postmaster@${DOMAIN}; pct=100\""}]
                }
              }
            ]
          }
          EOF
          
          aws route53 change-resource-record-sets \
            --hosted-zone-id ${ZONE_ID} \
            --change-batch file://dns-changes.json
          
          echo "✓ DNS records configured in Route 53"
          echo "Note: DKIM record must be added manually after retrieving the key from the server"

      - name: Display Next Steps
        run: |
          echo "========================================="
          echo "Mail Server Deployment Complete!"
          echo "========================================="
          echo ""
          echo "Next Steps:"
          echo "1. Retrieve DKIM key from server:"
          echo "   ssh ubuntu@${{ secrets.EC2_PUBLIC_IP }} 'cat ~/mail-server/docker-data/dms/config/opendkim/keys/${{ secrets.MAIL_DOMAIN }}/mail.txt'"
          echo ""
          echo "2. Add DKIM DNS record:"
          echo "   Name: mail._domainkey.${{ secrets.MAIL_DOMAIN }}"
          echo "   Type: TXT"
          echo "   Value: [DKIM key from step 1]"
          echo ""
          echo "3. Configure Reverse DNS (PTR) with your hosting provider:"
          echo "   ${{ secrets.SERVER_PUBLIC_IP }} -> ${{ secrets.MAIL_HOSTNAME }}"
          echo ""
          echo "4. Test email sending:"
          echo "   ssh ubuntu@${{ secrets.EC2_PUBLIC_IP }} 'cd ~/mail-server && ./test-email.sh your@email.com'"
          echo ""
          echo "5. Update TillDash backend .env:"
          echo "   EMAIL_HOST=${{ secrets.MAIL_HOSTNAME }}"
          echo "   EMAIL_PORT=587"
          echo "   EMAIL_USE_TLS=True"
          echo ""
          echo "View deployment: ssh ubuntu@${{ secrets.EC2_PUBLIC_IP }}"
          echo "View logs: ssh ubuntu@${{ secrets.EC2_PUBLIC_IP }} 'cd ~/mail-server && docker compose logs -f'"
